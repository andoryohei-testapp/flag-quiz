<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>国旗クイズ</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="国旗クイズ">
  <meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">

  
  <link rel="manifest" href="./manifest.json">

  <style>
   #result { font-size: 48px; font-weight: 800; margin: 12px 0 6px; }
#result small { display:block; font-size: 18px; font-weight: 600; margin-top: 6px; }
body { -webkit-tap-highlight-color: transparent; }
button { cursor: pointer; }
button:disabled { opacity: 0.5; }
 body { font-family: system-ui; margin: 16px; }
    .card { border: 1px solid #ddd; border-radius: 16px; padding: 16px; max-width: 600px; }
    button { padding: 12px; margin: 6px; border-radius: 12px; border: 1px solid #ccc; }
    .flagBox { width: 220px; border: 1px solid #eee; border-radius: 12px; overflow:hidden; }
    .flagBox img { width: 100%; display:block; }
  </style>
</head>

<body>
<div class="card">
  <h2>国旗→国名・首都クイズ</h2>
<div style="margin: 8px 0 12px 0;">
  <label><input type="radio" name="mode" value="country" checked> 国旗→国名</label>
  <label style="margin-left:12px;"><input type="radio" name="mode" value="capital"> 国旗→首都</label>
</div>

  
  <p>この国旗はどこの国？</p>
  <div class="flagBox">
    <img id="flag" src="">
  </div>
<p id="prompt" style="margin:10px 0 0 0; font-weight:700;"></p>
  <div id="choices"></div>
  <p id="result"></p>
<p id="score" style="margin:10px 0 0 0;"></p>

  <button onclick="newQuestion()">次の問題</button>
</div>

<script>
let DATA = [];

async function loadData(){
  const res = await fetch("./data_with_kana.json");
  DATA = await res.json();
}

async function start(){
  await loadData();
  renderScore();
  newQuestion();
}


start();


function flagPath(code){
  return "./flags/4x3/" + code + ".svg";
}

let current = null;

  // ---- スコア（localStorageに保存）----
const 

let scoreState = { correct: 0, wrong: 0, streak: 0, best: 0 };



function renderScore(){
  const el = document.getElementById("score");
  if(!el) return;
  el.textContent = `連続正解 ${scoreState.streak}　／　ベスト ${scoreState.best}`;
}



function getMode(){
  return document.querySelector('input[name="mode"]:checked')?.value || "country";
}
// 首都ふりがな（足りない分だけ上書き）
const CAPITAL_KANA_OVERRIDE = {
  "Kralendijk": "クラレンダイク",
  "El Aaiún": "アイウン",
  "City of Victoria": "ヴィクトリアシ",
  "Saipan": "サイパン",
  "Longyearbyen": "ロングイェールビーン",
  "Washington DC": "ワシントンディーシー",
  "Vatican City": "バチカン",
};

function newQuestion(){
  document.getElementById("result").textContent = "";

  // データ未読込ガード
  if (!DATA.length) return;

  const mode = getMode();

  // mode=capital のときは「首都が入ってる国」だけを出題対象にする
  let pool = DATA;
  if (mode === "capital") {
    pool = DATA.filter(x => (x.capital || "").trim().length > 0);
    if (!pool.length) {
      document.getElementById("result").textContent = "首都データがある国がありません";
      return;
    }
  }

  const i = Math.floor(Math.random() * pool.length);
  current = pool[i];
  current.answered = false;

// 国名表示（首都モードのときだけ）
const prompt = document.getElementById("prompt");
if (mode === "capital") {
  prompt.textContent = current.name + " の首都は？";
} else {
  prompt.textContent = "";
}

  document.getElementById("flag").src = flagPath(current.code);

  // choices（必ず正解を含める）
  let choices = [current];

  while (choices.length < 4) {
    const candidate = pool[Math.floor(Math.random() * pool.length)];
    if (!choices.some(c => c.code === candidate.code)) {
      choices.push(candidate);
    }
  }

  choices = choices.sort(() => Math.random() - 0.5);

  const div = document.getElementById("choices");
  div.innerHTML = "";

  choices.forEach(c=>{
    const btn = document.createElement("button");

    // 表示ラベル：国名 or 首都
    if (mode === "capital") {
const cap = c.capital || "（不明）";
const kanaRaw = CAPITAL_KANA_OVERRIDE[cap] || c.capital_kana || "";
const kana = kanaRaw ? `（${kanaRaw}）` : "";
btn.textContent = cap + kana;

} else {
  btn.textContent = c.name;
}


btn.onclick = () => {
  // 1問1回答（連打・別ボタンでの再回答を完全遮断）
  if (current.answered) return;
  current.answered = true;

  // ボタン全部無効化（“押した後に別の選択肢を押せる”を完全に潰す）
  document.querySelectorAll("#choices button").forEach(b => b.disabled = true);

  const result = document.getElementById("result");
  const isCorrect = (c.code === current.code); // 判定はここで1回だけ確定

  if (isCorrect) {
    // 正解加算（ここだけ）
   scoreState.streak += 1;
scoreState.best = Math.max(scoreState.best, scoreState.streak);
renderScore();

result.textContent = "⭕️";

  }

  // 不正解加算（ここだけ）
 scoreState.streak = 0;
renderScore();


  // 不正解時の“正解表示”（首都モード対応）
 if (mode === "capital") {
  const cap = current.capital || "（不明）";
  const kanaRaw = (CAPITAL_KANA_OVERRIDE[cap] || current.capital_kana || "");
  const kana = kanaRaw ? `（${kanaRaw}）` : "";
  result.innerHTML = "❌<small>正解は " + cap + kana + "</small>";
} else {
  result.innerHTML = "❌<small>正解は " + current.name + "</small>";
}




    div.appendChild(btn);
  });
}



</script>

</body>
</html>













